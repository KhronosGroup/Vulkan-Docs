// Copyright 2018-2022 The Khronos Group Inc.
//
// SPDX-License-Identifier: CC-BY-4.0

[[encode-h265]]
== Encode H.265

The `apiext:VK_EXT_video_encode_h265` extension adds H.265 codec-specific
structures/types needed to support H.265 video encoding.
Unless otherwise noted, all references to the H.265 specification are to the
2013 edition published by the ITU-T, dated April 2013.
This specification is available at https://www.itu.int/rec/T-REC-H.265.

[NOTE]
.Note
====
Refer to the <<preamble, Preamble>> for information on how the Khronos
Intellectual Property Rights Policy relates to normative references to
external materials not created by Khronos.
====


=== H.265 encode profile

An H.265 encode profile is specified by including the
slink:VkVideoEncodeH265ProfileInfoEXT structure in the pname:pNext chain of
the slink:VkVideoProfileInfoKHR structure when
slink:VkVideoProfileInfoKHR::pname:videoCodecOperation is
ename:VK_VIDEO_CODEC_OPERATION_ENCODE_H265_BIT_EXT.

[open,refpage='VkVideoEncodeH265ProfileInfoEXT',desc='Structure specifying H.265 encode profile',type='structs']
--
The sname:VkVideoEncodeH265ProfileInfoEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265ProfileInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:stdProfileIdc is a code:StdVideoH265ProfileIdc value specifying
    the H.265 codec profile IDC.

include::{generated}/validity/structs/VkVideoEncodeH265ProfileInfoEXT.adoc[]
--


=== Capabilities

[open,refpage='VkVideoEncodeH265CapabilitiesEXT',desc='Structure specifying H.265 encode capabilities',type='structs']
--
When calling flink:vkGetPhysicalDeviceVideoCapabilitiesKHR with
pname:pVideoProfile->videoCodecOperation specified as
ename:VK_VIDEO_CODEC_OPERATION_ENCODE_H265_BIT_EXT, the
slink:VkVideoEncodeH265CapabilitiesEXT structure must: be included in the
pname:pNext chain of the slink:VkVideoCapabilitiesKHR structure to retrieve
more capabilities specific to H.265 video encoding.

The sname:VkVideoEncodeH265CapabilitiesEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265CapabilitiesEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:flags is a bitmask of elink:VkVideoEncodeH265CapabilityFlagBitsEXT
    describing supported encoding tools.
  * pname:inputModeFlags is a bitmask of
    elink:VkVideoEncodeH265InputModeFlagBitsEXT describing the command
    buffer input granularities/modes supported by the implementation.
  * pname:outputModeFlags is a bitmask of
    elink:VkVideoEncodeH265OutputModeFlagBitsEXT describing the output
    (bitstream size reporting) granularities/modes supported by the
    implementation.
  * pname:ctbSizes is a bitmask of elink:VkVideoEncodeH265CtbSizeFlagBitsEXT
    describing the supported CTB sizes.
  * pname:transformBlockSizes is a bitmask of
    elink:VkVideoEncodeH265TransformBlockSizeFlagBitsEXT describing the
    supported transform block sizes.
  * pname:maxPPictureL0ReferenceCount reports the maximum number of
    reference pictures the implementation supports in the reference list L0
    for P pictures.
  * pname:maxBPictureL0ReferenceCount reports the maximum number of
    reference pictures the implementation supports in the reference list L0
    for B pictures.
    The reported value is `0` if encoding of B pictures is not supported.
  * pname:maxL1ReferenceCount reports the maximum number of reference
    pictures the implementation supports in the reference list L1 if
    encoding of B pictures is supported.
    The reported value is `0` if encoding of B pictures is not supported.
  * pname:maxSubLayersCount reports the maximum number of sublayers.
  * pname:minLog2MinLumaCodingBlockSizeMinus3 reports the minimum value that
    may be set for log2_min_luma_coding_block_size_minus3 in
    StdVideoH265SequenceParameterSet.
  * pname:maxLog2MinLumaCodingBlockSizeMinus3 reports the maximum value that
    may be set for log2_min_luma_coding_block_size_minus3 in
    StdVideoH265SequenceParameterSet.
  * pname:minLog2MinLumaTransformBlockSizeMinus2 reports the minimum value
    that may be set for log2_min_luma_transform_block_size_minus2 in
    StdVideoH265SequenceParameterSet.
  * pname:maxLog2MinLumaTransformBlockSizeMinus2 reports the maximum value
    that may be set for log2_min_luma_transform_block_size_minus2 in
    StdVideoH265SequenceParameterSet.
  * pname:minMaxTransformHierarchyDepthInter reports the minimum value that
    may be set for max_transform_hierarchy_depth_inter in
    StdVideoH265SequenceParameterSet.
  * pname:maxMaxTransformHierarchyDepthInter reports the maximum value that
    may be set for max_transform_hierarchy_depth_inter in
    StdVideoH265SequenceParameterSet.
  * pname:minMaxTransformHierarchyDepthIntra reports the minimum value that
    may be set for max_transform_hierarchy_depth_intra in
    StdVideoH265SequenceParameterSet.
  * pname:maxMaxTransformHierarchyDepthIntra reports the maximum value that
    may be set for max_transform_hierarchy_depth_intra in
    StdVideoH265SequenceParameterSet.
  * pname:maxDiffCuQpDeltaDepth reports the maximum value that may be set
    for diff_cu_qp_delta_depth in StdVideoH265PictureParameterSet.
  * pname:minMaxNumMergeCand reports the minimum value that may be set for
    MaxNumMergeCand in StdVideoEncodeH265SliceHeader.
  * pname:maxMaxNumMergeCand reports the maximum value that may be set for
    MaxNumMergeCand in StdVideoEncodeH265SliceHeader.

include::{generated}/validity/structs/VkVideoEncodeH265CapabilitiesEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265CapabilityFlagsEXT',desc='Bitmask of VkVideoEncodeH265CapabilityFlagBitsEXT',type='flags']
--
include::{generated}/api/flags/VkVideoEncodeH265CapabilityFlagsEXT.adoc[]

tname:VkVideoEncodeH265CapabilityFlagsEXT is a bitmask type for setting a
mask of zero or more elink:VkVideoEncodeH265CapabilityFlagBitsEXT.
--

[open,refpage='VkVideoEncodeH265CapabilityFlagBitsEXT',desc='Video encode H.265 capability flags',type='enums']
--
Bits which may: be set in
slink:VkVideoEncodeH265CapabilitiesEXT::pname:flags, indicating the encoding
tools supported, are:

include::{generated}/api/enums/VkVideoEncodeH265CapabilityFlagBitsEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SEPARATE_COLOUR_PLANE_BIT_EXT
    reports if enabling separate_colour_plane_flag in StdVideoH265SpsFlags
    is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SCALING_LISTS_BIT_EXT reports if
    enabling scaling_list_enabled_flag and
    sps_scaling_list_data_present_flag in StdVideoH265SpsFlags, or enabling
    pps_scaling_list_data_present_flag in StdVideoH265PpsFlags are
    supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SAMPLE_ADAPTIVE_OFFSET_ENABLED_BIT_EXT
    reports if enabling sample_adaptive_offset_enabled_flag in
    StdVideoH265SpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_PCM_ENABLE_BIT_EXT reports if
    enabling pcm_enable_flag in StdVideoH265SpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SPS_TEMPORAL_MVP_ENABLED_BIT_EXT
    reports if enabling sps_temporal_mvp_enabled_flag in
    StdVideoH265SpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_HRD_COMPLIANCE_BIT_EXT reports if
    the implementation guarantees generating a HRD compliant bitstream if
    nal_hrd_parameters_present_flag, vcl_hrd_parameters_present_flag, or
    sub_pic_hrd_params_present_flag are enabled in StdVideoH265HrdFlags, or
    vui_hrd_parameters_present_flag is enabled in StdVideoH265SpsVuiFlags.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_INIT_QP_MINUS26_BIT_EXT reports if
    setting non-zero init_qp_minus26 in StdVideoH265PictureParameterSet is
    supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_LOG2_PARALLEL_MERGE_LEVEL_MINUS2_BIT_EXT
    reports if setting non-zero value for log2_parallel_merge_level_minus2
    in StdVideoH265PictureParameterSet is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SIGN_DATA_HIDING_ENABLED_BIT_EXT
    reports if enabling sign_data_hiding_enabled_flag in
    StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_TRANSFORM_SKIP_ENABLED_BIT_EXT
    reports if enabling transform_skip_enabled_flag in StdVideoH265PpsFlags
    is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_TRANSFORM_SKIP_DISABLED_BIT_EXT
    reports if disabling transform_skip_enabled_flag in StdVideoH265PpsFlags
    is supported.
    Implementations must: report at least one of
    ename:VK_VIDEO_ENCODE_H265_CAPABILITY_TRANSFORM_SKIP_ENABLED_BIT_EXT and
    ename:VK_VIDEO_ENCODE_H265_CAPABILITY_TRANSFORM_SKIP_DISABLED_BIT_EXT as
    supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_PPS_SLICE_CHROMA_QP_OFFSETS_PRESENT_BIT_EXT
    reports if enabling pps_slice_chroma_qp_offsets_present_flag in
    StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_WEIGHTED_PRED_BIT_EXT reports if
    enabling weighted_pred_flag in StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_WEIGHTED_BIPRED_BIT_EXT reports if
    enabling weighted_bipred_flag in StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_WEIGHTED_PRED_NO_TABLE_BIT_EXT
    reports that when weighted_pred_flag or weighted_bipred_flag in
    StdVideoH265PpsFlags are enabled, the implementation is able to
    internally decide syntax for pred_weight_table.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_TRANSQUANT_BYPASS_ENABLED_BIT_EXT
    reports if enabling transquant_bypass_enabled_flag in
    StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_ENTROPY_CODING_SYNC_ENABLED_BIT_EXT
    reports if enabling entropy_coding_sync_enabled_flag in
    StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_DEBLOCKING_FILTER_OVERRIDE_ENABLED_BIT_EXT
    reports if enabling deblocking_filter_override_enabled_flag in
    StdVideoH265PpsFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_MULTIPLE_TILE_PER_FRAME_BIT_EXT
    reports if encoding multiple tiles per frame is supported.
    If not set, the implementation is only able to encode a single tile for
    each frame.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_MULTIPLE_SLICE_PER_TILE_BIT_EXT
    reports if encoding multiple slices per tile is supported.
    If not set, the implementation is only able to encode a single slice for
    each tile.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_MULTIPLE_TILE_PER_SLICE_BIT_EXT
    reports if encoding multiple tiles per slice is supported.
    If not set, the implementation is only able to encode a single tile for
    each slice.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_SLICE_SEGMENT_CTB_COUNT_BIT_EXT
    reports support for configuring
    slink:VkVideoEncodeH265NaluSliceSegmentInfoEXT::pname:ctbCount and
    slice_segment_address in StdVideoEncodeH265SliceSegmentHeader for each
    slice segment in a frame with multiple slice segments.
    If not supported, the implementation decides the number of CTBs in each
    slice segment based on
    slink:VkVideoEncodeH265VclFrameInfoEXT::pname:naluSliceSegmentEntryCount.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_ROW_UNALIGNED_SLICE_SEGMENT_BIT_EXT
    reports that each slice segment in a frame with a single or multiple
    tiles per slice may begin or finish at any offset in a CTB row.
    If not supported, all slice segments in such a frame must: begin at the
    start of a CTB row (and hence each slice segment must: finish at the end
    of a CTB row).
    Also reports that each slice segment in a frame with multiple slices per
    tile may begin or finish at any offset within the enclosing tile's CTB
    row.
    If not supported, slice segments in such a frame must: begin at the
    start of the enclosing tile's CTB row (and hence each slice segment
    must: finish at the end of the enclosing tile's CTB row).
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_DEPENDENT_SLICE_SEGMENT_BIT_EXT
    reports if enabling dependent_slice_segment_flag in
    StdVideoEncodeH265SliceHeaderFlags is supported.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_DIFFERENT_SLICE_TYPE_BIT_EXT
    reports that when
    ename:VK_VIDEO_ENCODE_H265_CAPABILITY_MULTIPLE_SLICE_PER_TILE_BIT_EXT is
    supported and a frame is encoded with multiple slices, the
    implementation allows encoding each slice segment with a different
    code:StdVideoEncodeH265SliceSegmentHeader::slice_type.
    If not supported, all slice segments of the frame must: be encoded with
    the same code:slice_type which corresponds to the picture type of the
    frame.
    For example, all slice segments of a P-frame would be encoded as
    P-slices.
  * ename:VK_VIDEO_ENCODE_H265_CAPABILITY_B_FRAME_IN_L1_LIST_BIT_EXT reports
    support for using a B frame as L1 reference.
--

[open,refpage='VkVideoEncodeH265InputModeFlagsEXT',desc='Bitmask of VkVideoEncodeH265InputModeFlagBitsEXT',type='flags']
--
include::{generated}/api/flags/VkVideoEncodeH265InputModeFlagsEXT.adoc[]

tname:VkVideoEncodeH265InputModeFlagsEXT is a bitmask type for setting a
mask of zero or more elink:VkVideoEncodeH265InputModeFlagBitsEXT.
--

[open,refpage='VkVideoEncodeH265InputModeFlagBitsEXT',desc='Video encode H.265 input modes',type='enums']
--
Bits which may: be set in
slink:VkVideoEncodeH265CapabilitiesEXT::pname:inputModeFlags, indicating the
command buffer input granularities supported by the implementation, are:

include::{generated}/api/enums/VkVideoEncodeH265InputModeFlagBitsEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_FRAME_BIT_EXT indicates that a
    single command buffer must: at least encode an entire frame.
    Any non-VCL NALUs must: be encoded using the same command buffer as the
    frame if ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_NON_VCL_BIT_EXT is not
    supported.
  * ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_SLICE_SEGMENT_BIT_EXT indicates
    that a single command buffer must: at least encode a single slice
    segment.
    Any non-VCL NALUs must: be encoded using the same command buffer as the
    first slice segment of the frame if
    ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_NON_VCL_BIT_EXT is not supported.
  * ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_NON_VCL_BIT_EXT indicates that a
    single command buffer may: encode a non-VCL NALU by itself.

An implementation must: support at least one of
ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_FRAME_BIT_EXT or
ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_SLICE_SEGMENT_BIT_EXT.

If ename:VK_VIDEO_ENCODE_H265_INPUT_MODE_SLICE_SEGMENT_BIT_EXT is not
supported, the following two additional restrictions apply for frames
encoded with multiple slice segments.
First, all frame slice segments must: have the same pReferenceFinalLists.
Second, the order in which slice segments appear in
slink:VkVideoEncodeH265VclFrameInfoEXT::pname:pNaluSliceSegmentEntries or in
the command buffer must: match the placement order of the slice segments in
the frame.
--

[open,refpage='VkVideoEncodeH265OutputModeFlagsEXT',desc='Bitmask of VkVideoEncodeH265OutputModeFlagBitsEXT',type='flags']
--
include::{generated}/api/flags/VkVideoEncodeH265OutputModeFlagsEXT.adoc[]

tname:VkVideoEncodeH265OutputModeFlagsEXT is a bitmask type for setting a
mask of zero or more elink:VkVideoEncodeH265OutputModeFlagBitsEXT.
--

[open,refpage='VkVideoEncodeH265OutputModeFlagBitsEXT',desc='Video encode H.265 output modes',type='enums']
--
Bits which may: be set in
slink:VkVideoEncodeH265CapabilitiesEXT::pname:outputModeFlags, indicating
the minimum bitstream generation commands that must: be included between
each flink:vkCmdBeginVideoCodingKHR and flink:vkCmdEndVideoCodingKHR pair
(henceforth simply begin/end pair), are:

include::{generated}/api/enums/VkVideoEncodeH265OutputModeFlagBitsEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_FRAME_BIT_EXT indicates that
    calls to generate all NALUs of a frame must: be included within a single
    begin/end pair.
    Any non-VCL NALUs must: be encoded within the same begin/end pair if
    ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_NON_VCL_BIT_EXT is not supported.
  * ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_SLICE_SEGMENT_BIT_EXT indicates
    that each begin/end pair must: encode at least one slice segment.
    Any non-VCL NALUs must: be encoded within the same begin/end pair as the
    first slice segment of the frame if
    ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_NON_VCL_BIT_EXT is not supported.
  * ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_NON_VCL_BIT_EXT indicates that
    each begin/end pair may: encode only a non-VCL NALU by itself.
    An implementation must: support at least one of
    ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_FRAME_BIT_EXT or
    ename:VK_VIDEO_ENCODE_H265_OUTPUT_MODE_SLICE_SEGMENT_BIT_EXT.

A single begin/end pair must: not encode more than a single frame.

The bitstreams of NALUs generated within a single begin/end pair are written
continuously into the same bitstream buffer (any padding between the NALUs
must: be compliant to the H.265 standard).

The supported input modes must: be coarser or equal to the supported output
modes.
For example, it is illegal to report slice segment input is supported but
only frame output is supported.

An implementation must: report one of the following combinations of
input/output modes:

  * Input: Frame, Output: Frame
  * Input: Frame, Output: Frame and Non-VCL
  * Input: Frame, Output: Slice Segment
  * Input: Frame, Output: Slice Segment and Non-VCL
  * Input: Slice Segment, Output: Slice Segment
  * Input: Slice Segment, Output: Slice Segment and Non-VCL
  * Input: Frame and Non-VCL, Output: Frame and Non-VCL
  * Input: Frame and Non-VCL, Output: Slice Segment and Non-VCL
  * Input: Slice Segment and Non-VCL, Output: Slice Segment and Non-VCL
--

[open,refpage='VkVideoEncodeH265CtbSizeFlagsEXT',desc='Bitmask of VkVideoEncodeH265CtbSizeFlagBitsEXT',type='flags']
--
include::{generated}/api/flags/VkVideoEncodeH265CtbSizeFlagsEXT.adoc[]

tname:VkVideoEncodeH265CtbSizeFlagsEXT is a bitmask type for setting a mask
of zero or more elink:VkVideoEncodeH265CtbSizeFlagBitsEXT.
Implementations must: set at least one of
ename:VkVideoEncodeH265CtbSizeFlagBitsEXT.
--

[open,refpage='VkVideoEncodeH265CtbSizeFlagBitsEXT',desc='Supported CTB sizes for H.265 video encode',type='enums']
--
Bits which may: be set in
slink:VkVideoEncodeH265CapabilitiesEXT::pname:ctbSizes, indicating the CTB
sizes supported by the implementation, are:

include::{generated}/api/enums/VkVideoEncodeH265CtbSizeFlagBitsEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_CTB_SIZE_16_BIT_EXT specifies that a CTB size
    of 16x16 is supported.
  * ename:VK_VIDEO_ENCODE_H265_CTB_SIZE_32_BIT_EXT specifies that a CTB size
    of 32x32 is supported.
  * ename:VK_VIDEO_ENCODE_H265_CTB_SIZE_64_BIT_EXT specifies that a CTB size
    of 64x64 is supported.
--

[open,refpage='VkVideoEncodeH265TransformBlockSizeFlagsEXT',desc='Bitmask of VkVideoEncodeH265TransformBlockSizeFlagBitsEXT',type='flags']
--
include::{generated}/api/flags/VkVideoEncodeH265TransformBlockSizeFlagsEXT.adoc[]

tname:VkVideoEncodeH265TransformBlockSizeFlagsEXT is a bitmask type for
setting a mask of zero or more
elink:VkVideoEncodeH265TransformBlockSizeFlagBitsEXT.
Implementations must: set at least one of
ename:VkVideoEncodeH265TransformBlockSizeFlagBitsEXT.
--

[open,refpage='VkVideoEncodeH265TransformBlockSizeFlagBitsEXT',desc='Supported transform block sizes for H.265 video encode',type='enums']
--
Bits which may: be set in
slink:VkVideoEncodeH265CapabilitiesEXT::pname:transformBlockSizes,
indicating the transform block sizes supported by the implementation, are:

include::{generated}/api/enums/VkVideoEncodeH265TransformBlockSizeFlagBitsEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_TRANSFORM_BLOCK_SIZE_4_BIT_EXT specifies that
    a transform block size of 4x4 is supported.
  * ename:VK_VIDEO_ENCODE_H265_TRANSFORM_BLOCK_SIZE_8_BIT_EXT specifies that
    a transform block size of 8x8 is supported.
  * ename:VK_VIDEO_ENCODE_H265_TRANSFORM_BLOCK_SIZE_16_BIT_EXT specifies
    that a transform block size of 16x16 is supported.
  * ename:VK_VIDEO_ENCODE_H265_TRANSFORM_BLOCK_SIZE_32_BIT_EXT specifies
    that a transform block size of 32x32 is supported.
--


=== Encoder H.265 Video Session Parameters Object

When creating a Video Session Parameters object, add a
slink:VkVideoEncodeH265SessionParametersCreateInfoEXT structure to the
pname:pNext chain of the slink:VkVideoSessionParametersCreateInfoKHR
structure passed to flink:vkCreateVideoSessionParametersKHR in order to
specify the H.265-specific video encoder session parameters.

[open,refpage='VkVideoEncodeH265SessionParametersCreateInfoEXT',desc='Structure specifies H.265 encoder parameter set info',type='structs']
--
The sname:VkVideoEncodeH265SessionParametersCreateInfoEXT structure is
defined as:

include::{generated}/api/structs/VkVideoEncodeH265SessionParametersCreateInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:maxStdVPSCount is the maximum number of entries of type
    code:StdVideoH265VideoParameterSet within
    sname:VkVideoSessionParametersKHR.
  * pname:maxStdSPSCount is the maximum number of entries of type
    code:StdVideoH265SequenceParameterSet within
    sname:VkVideoSessionParametersKHR.
  * pname:maxStdPPSCount is the maximum number of entries of type
    code:StdVideoH265PictureParameterSet within
    sname:VkVideoSessionParametersKHR.
  * pname:pParametersAddInfo is `NULL` or a pointer to a
    slink:VkVideoEncodeH265SessionParametersAddInfoEXT structure specifying
    the video session parameters to add upon creation of this object.

When a slink:VkVideoSessionParametersKHR object contains
pname:maxStdVPSCount code:StdVideoH265VideoParameterSet entries, no
additional code:StdVideoH265VideoParameterSet entries can be added to it,
and ename:VK_ERROR_TOO_MANY_OBJECTS will be returned if an attempt is made
to add these entries.
When a slink:VkVideoSessionParametersKHR object contains
pname:maxStdSPSCount code:StdVideoH265SequenceParameterSet entries, no
additional code:StdVideoH265SequenceParameterSet entries can be added to it,
and ename:VK_ERROR_TOO_MANY_OBJECTS will be returned if an attempt is made
to add these entries.
When a slink:VkVideoSessionParametersKHR object contains
pname:maxStdPPSCount code:StdVideoH265PictureParameterSet entries, no
additional code:StdVideoH265PictureParameterSet entries can be added to it,
and ename:VK_ERROR_TOO_MANY_OBJECTS will be returned if an attempt is made
to add these entries.

include::{generated}/validity/structs/VkVideoEncodeH265SessionParametersCreateInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265SessionParametersAddInfoEXT',desc='Structure specifies H.265 encoder parameter set info',type='structs']
--
The sname:VkVideoEncodeH265SessionParametersAddInfoEXT structure is defined
as:

include::{generated}/api/structs/VkVideoEncodeH265SessionParametersAddInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:stdVPSCount is the number of VPS elements in pname:pStdVPSs.
  * pname:pStdVPSs is a pointer to an array of pname:stdVPSCount
    code:StdVideoH265VideoParameterSet structures representing H.265 video
    parameter sets.
  * pname:stdSPSCount is the number of SPS elements in pname:pStdSPSs.
  * pname:pStdSPSs is a pointer to an array of pname:stdSPSCount
    code:StdVideoH265SequenceParameterSet structures representing H.265
    sequence parameter sets.
  * pname:stdPPSCount is the number of PPS elements in pname:pStdPPSs.
  * pname:pStdPPSs is a pointer to an array of pname:stdPPSCount
    code:StdVideoH265PictureParameterSet structures representing H.265
    picture parameter sets.

include::{generated}/validity/structs/VkVideoEncodeH265SessionParametersAddInfoEXT.adoc[]

.Valid Usage
****
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-stdVPSCount-06438]]
    The values of pname:stdVPSCount, pname:stdSPSCount and pname:stdPPSCount
    must: be less than or equal to the values of
    slink:VkVideoEncodeH265SessionParametersCreateInfoEXT::pname:maxStdVPSCount,
    slink:VkVideoEncodeH265SessionParametersCreateInfoEXT:pname:maxStdSPSCount,
    and
    slink:VkVideoEncodeH265SessionParametersCreateInfoEXT:pname:maxStdPPSCount,
    respectively
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-pStdVPSs-06439]]
    Each code:StdVideoH265VideoParameterSet entry in pname:pStdVPSs must:
    have a unique H.265 VPS ID
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-pStdSPSs-06440]]
    Each code:StdVideoH265SequenceParameterSet entry in pname:pStdSPSs must:
    have a unique H.265 VPS-SPS ID pair
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-pStdPPSs-06441]]
    Each code:StdVideoH265PictureParameterSet entry in pname:pStdPPSs must:
    have a unique H.265 VPS-SPS-PPS ID tuple
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-None-06442]]
    Each entry to be added must: have a unique, to the rest of the parameter
    array entries and the existing parameters in the Video Session
    Parameters Object that is being updated, VPS-SPS-PPS IDs
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-None-06443]]
    Parameter entries that already exist in Video Session Parameters object
    with a particular VPS-SPS-PPS IDs must: not be replaced nor updated
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-None-06444]]
    When creating a new object using a Video Session Parameters as a
    template, the array's parameters with the same VPS-SPS-PPS IDs as the
    ones from the template take precedence
  * [[VUID-VkVideoEncodeH265SessionParametersAddInfoEXT-None-06445]]
    VPS/SPS/PPS parameters must: comply with the limits specified in
    slink:VkVideoSessionCreateInfoKHR during Video Session creation
****
--


=== Frame Encoding

In order to encode a frame, add a slink:VkVideoEncodeH265VclFrameInfoEXT
structure to the pname:pNext chain of the slink:VkVideoEncodeInfoKHR
structure passed to the flink:vkCmdEncodeVideoKHR command.

[open,refpage='VkVideoEncodeH265VclFrameInfoEXT',desc='Structure specifies H.265 encode frame parameters',type='structs']
--
The slink:VkVideoEncodeH265VclFrameInfoEXT structure representing a frame
encode operation is defined as:

include::{generated}/api/structs/VkVideoEncodeH265VclFrameInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:pReferenceFinalLists is `NULL` or a pointer to a
    slink:VkVideoEncodeH265ReferenceListsInfoEXT structure specifying the
    reference lists to be used for the current picture.
  * pname:naluSliceSegmentEntryCount is the number of slice segment NALUs in
    the frame.
  * pname:pNaluSliceSegmentEntries is a pointer to an array of
    slink:VkVideoEncodeH265NaluSliceSegmentInfoEXT structures specifying the
    division of the current picture into slice segments and the properties
    of these slice segments.
  * pname:pCurrentPictureInfo is a pointer to a
    code:StdVideoEncodeH265PictureInfo structure specifying the syntax and
    other codec-specific information from the H.265 specification,
    associated with this picture.

include::{generated}/validity/structs/VkVideoEncodeH265VclFrameInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265NaluSliceSegmentInfoEXT',desc='Structure specifies H.265 encode slice segment NALU parameters',type='structs']
--
The slink:VkVideoEncodeH265NaluSliceSegmentInfoEXT structure representing a
slice segment is defined as:

include::{generated}/api/structs/VkVideoEncodeH265NaluSliceSegmentInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:ctbCount is the number of CTBs in this slice segment.
  * pname:pReferenceFinalLists is `NULL` or a pointer to a
    slink:VkVideoEncodeH265ReferenceListsInfoEXT structure specifying the
    reference lists to be used for the current slice segment.
    If pname:pReferenceFinalLists is not `NULL`, these reference lists
    override the reference lists provided in
    slink:VkVideoEncodeH265VclFrameInfoEXT::pname:pReferenceFinalLists.
  * pname:pSliceSegmentHeaderStd is a pointer to a
    code:StdVideoEncodeH265SliceSegmentHeader structure specifying the slice
    segment header for the current slice segment.

include::{generated}/validity/structs/VkVideoEncodeH265NaluSliceSegmentInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265DpbSlotInfoEXT',desc='Structure specifies H.265 encode decoded pic info',type='structs']
--
The slink:VkVideoEncodeH265DpbSlotInfoEXT structure, representing a
reconstructed picture that is being used as a reference picture, is defined
as:

include::{generated}/api/structs/VkVideoEncodeH265DpbSlotInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:slotIndex is the <<dpb-slot, DPB Slot>> index for this picture.
  * pname:pStdReferenceInfo is a pointer to a
    code:StdVideoEncodeH265ReferenceInfo structure specifying the syntax and
    other codec-specific information from the H.265 specification,
    associated with this reference picture.

include::{generated}/validity/structs/VkVideoEncodeH265DpbSlotInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265ReferenceListsInfoEXT',desc='Structure specifies H.265 reference frame lists',type='structs']
--
The slink:VkVideoEncodeH265ReferenceListsInfoEXT structure representing
reference lists is defined as:

include::{generated}/api/structs/VkVideoEncodeH265ReferenceListsInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:referenceList0EntryCount is the number of reference pictures in
    reference list L0 and is identical to
    code:StdVideoEncodeH265SliceSegmentHeader::pname:num_ref_idx_l0_active_minus1
    + 1.
  * pname:pReferenceList0Entries is a pointer to an array of
    pname:referenceList0EntryCount slink:VkVideoEncodeH265DpbSlotInfoEXT
    structures specifying the reference list L0 entries for the current
    picture.
  * pname:referenceList1EntryCount is the number of reference pictures in
    reference list L1 and is identical to
    code:StdVideoEncodeH265SliceSegmentHeader::pname:num_ref_idx_l1_active_minus1
    + 1.
  * pname:pReferenceList1Entries is a pointer to an array of
    pname:referenceList1EntryCount slink:VkVideoEncodeH265DpbSlotInfoEXT
    structures specifying the reference list L1 entries for the current
    picture.
  * pname:pReferenceModifications is a pointer to a
    code:StdVideoEncodeH265ReferenceModifications structure specifying
    reference list modifications.

include::{generated}/validity/structs/VkVideoEncodeH265ReferenceListsInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265EmitPictureParametersInfoEXT',desc='Structure specifies H.265 encode VPS NALU insertion parameters',type='structs']
--
The slink:VkVideoEncodeH265EmitPictureParametersInfoEXT structure is defined
as:

include::{generated}/api/structs/VkVideoEncodeH265EmitPictureParametersInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:vpsId is the H.265 VPS ID for the H.265 VPS to insert in the
    bitstream.
    The VPS ID must: match the VPS provided in pname:vpsStd of
    slink:VkVideoEncodeH265SessionParametersCreateInfoEXT.
    This is retrieved from the slink:VkVideoSessionParametersKHR object
    provided in slink:VkVideoBeginCodingInfoKHR.
  * pname:spsId is the H.265 SPS ID for the H.265 SPS to insert in the
    bitstream.
    The SPS ID must: match one of the IDs of the SPS(s) provided in
    pname:pStdSPSs of slink:VkVideoEncodeH265SessionParametersCreateInfoEXT
    to identify the SPS parameter set to insert in the bitstream.
    This is retrieved from the slink:VkVideoSessionParametersKHR object
    provided in slink:VkVideoBeginCodingInfoKHR.
  * pname:emitVpsEnable enables the emitting of the VPS structure with id of
    pname:vpsId.
  * pname:emitSpsEnable enables the emitting of the SPS structure with id of
    pname:spsId.
  * pname:ppsIdEntryCount is the number of entries in the
    pname:ppsIdEntries.
    If this parameter is `0` then no pps entries are going to be emitted in
    the bitstream.
  * pname:ppsIdEntries is the H.265 PPS IDs for the H.265 PPS to insert in
    the bitstream.
    The PPS IDs must: match one of the IDs of the PPS(s) provided in
    pname:pStdPPSs of slink:VkVideoEncodeH265SessionParametersCreateInfoEXT
    to identify the PPS parameter set to insert in the bitstream.
    This is retrieved from the slink:VkVideoSessionParametersKHR object
    provided in slink:VkVideoBeginCodingInfoKHR.

include::{generated}/validity/structs/VkVideoEncodeH265EmitPictureParametersInfoEXT.adoc[]
--


=== Rate control

[open,refpage='VkVideoEncodeH265RateControlInfoEXT',desc='Structure describing H.265 stream rate control parameters',type='structs']
--
The sname:VkVideoEncodeH265RateControlInfoEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265RateControlInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:gopFrameCount is the number of frames contained within the group
    of pictures (GOP), starting from an intra frame and until the next intra
    frame.
    If it is set to 0, the implementation chooses a suitable value.
    If it is set to code:UINT32_MAX, the GOP length is treated as infinite.
  * pname:idrPeriod is the interval, in terms of number of frames, between
    two IDR frames.
    If it is set to 0, the implementation chooses a suitable value.
    If it is set to code:UINT32_MAX, the IDR period is treated as infinite.
  * pname:consecutiveBFrameCount is the number of consecutive B-frames
    between I- and/or P-frames within the GOP.
  * pname:rateControlStructure is a
    elink:VkVideoEncodeH265RateControlStructureEXT value specifying the
    expected encode stream reference structure, to aid in rate control
    calculations.
  * pname:subLayerCount specifies the number of sub layers enabled in the
    stream.

In order to provide H.265-specific stream rate control parameters, add a
sname:VkVideoEncodeH265RateControlInfoEXT structure to the pname:pNext chain
of the slink:VkVideoEncodeRateControlInfoKHR structure in the pname:pNext
chain of the slink:VkVideoCodingControlInfoKHR structure passed to the
flink:vkCmdControlVideoCodingKHR command.

The parameters from this structure act as a guidance for implementations to
apply various rate control heuristics.

It is possible to infer the picture type to be used when encoding a frame,
on the basis of the values provided for pname:consecutiveBFrameCount,
pname:idrPeriod, and pname:gopFrameCount, but this inferred picture type
will not be used by implementations to override the picture type provided in
flink:vkCmdEncodeVideoKHR.
Additionally, it is not required for the video session to be reset if the
inferred picture type does not match the actual picture type.

include::{generated}/validity/structs/VkVideoEncodeH265RateControlInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265RateControlStructureEXT',desc='Specifies the video encode H.265 rate control structure',type='enums']
--
Possible values of
slink:VkVideoEncodeH265RateControlInfoEXT::pname:rateControlStructure,
specifying a video stream reference structure as a hint for the rate control
implementation, are:

include::{generated}/api/enums/VkVideoEncodeH265RateControlStructureEXT.adoc[]

  * ename:VK_VIDEO_ENCODE_H265_RATE_CONTROL_STRUCTURE_UNKNOWN_EXT specifies
    a reference structure unknown at the time of stream rate control
    configuration.
  * ename:VK_VIDEO_ENCODE_H265_RATE_CONTROL_STRUCTURE_FLAT_EXT specifies a
    flat reference structure.
  * ename:VK_VIDEO_ENCODE_H265_RATE_CONTROL_STRUCTURE_DYADIC_EXT specifies a
    dyadic reference structure.
--

[open,refpage='VkVideoEncodeH265RateControlLayerInfoEXT',desc='Structure describing H.265 per-layer rate control parameters',type='structs']
--
The sname:VkVideoEncodeH265RateControlLayerInfoEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265RateControlLayerInfoEXT.adoc[]

  * pname:sType is the type of this structure.
  * pname:pNext is `NULL` or a pointer to a structure extending this
    structure.
  * pname:temporalId specifies the H.265 temporal ID of the video coding
    layer that settings provided in this structure and its parent
    slink:VkVideoEncodeRateControlLayerInfoKHR structure apply to.
  * pname:useInitialRcQp indicates whether the values within
    pname:initialRcQp should be used by the implementation.
  * pname:initialRcQp provides the QP values for each picture type, to be
    used in rate control calculations at the start of video encode
    operations on a newly-created video session, or immediately after a
    session reset.
    These values are ignored when
    slink:VkVideoEncodeRateControlInfoKHR::pname:rateControlMode is
    ename:VK_VIDEO_ENCODE_RATE_CONTROL_MODE_NONE_BIT_KHR.
  * pname:useMinQp indicates whether the values within pname:minQp should be
    used by the implementation.
    When it is set to ename:VK_FALSE, the implementation ignores the values
    in pname:minQp and chooses suitable values.
  * pname:minQp provides the lower bound on the QP values for each picture
    type, to be used in rate control calculations.
  * pname:useMaxQp indicates whether the values within pname:maxQp should be
    used by the implementation.
    When it is set to ename:VK_FALSE, the implementation ignores the values
    in pname:maxQp and chooses suitable values.
  * pname:maxQp provides the upper bound on the QP values for each picture
    type, to be used in rate control calculations.
  * pname:useMaxFrameSize indicates whether the values within
    pname:maxFrameSize should be used by the implementation.
  * pname:maxFrameSize provides the upper bound on the encoded frame size
    for each picture type.
    The implementation does not guarantee the encoded frame sizes will be
    within the specified limits, however these limits may: be used as a
    guide in rate control calculations.
    If enabled and not set properly, the pname:maxQp limit may prevent the
    implementation from respecting the pname:maxFrameSize limit.

H.265-specific per-layer rate control parameters must: be specified by
adding a sname:VkVideoEncodeH265RateControlLayerInfoEXT structure to the
pname:pNext chain of each slink:VkVideoEncodeRateControlLayerInfoKHR
structure in a call to flink:vkCmdControlVideoCodingKHR command, when the
command buffer context has an active video encode H.265 session.

.Valid Usage
****
  * [[VUID-VkVideoEncodeH265RateControlLayerInfoEXT-rateControlMode-06476]]
    When slink:VkVideoEncodeRateControlInfoKHR::pname:rateControlMode is
    ename:VK_VIDEO_ENCODE_RATE_CONTROL_MODE_NONE_BIT_KHR, both
    pname:useMinQp and pname:useMaxQp must be set to ename:VK_TRUE
  * [[VUID-VkVideoEncodeH265RateControlLayerInfoEXT-rateControlMode-06477]]
    When slink:VkVideoEncodeRateControlInfoKHR::pname:rateControlMode is
    ename:VK_VIDEO_ENCODE_RATE_CONTROL_MODE_NONE_BIT_KHR, the values
    provided in pname:minQP must be identical to those provided in
    pname:maxQp
****

include::{generated}/validity/structs/VkVideoEncodeH265RateControlLayerInfoEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265QpEXT',desc='Structure describing H.265 QP values per picture type',type='structs']
--
The sname:VkVideoEncodeH265QpEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265QpEXT.adoc[]

  * pname:qpI is the QP to be used for I-frames.
  * pname:qpP is the QP to be used for P-frames.
  * pname:qpB is the QP to be used for B-frames.

include::{generated}/validity/structs/VkVideoEncodeH265QpEXT.adoc[]
--

[open,refpage='VkVideoEncodeH265FrameSizeEXT',desc='Structure describing frame size values per H.265 picture type',type='structs']
--
The sname:VkVideoEncodeH265FrameSizeEXT structure is defined as:

include::{generated}/api/structs/VkVideoEncodeH265FrameSizeEXT.adoc[]

  * pname:frameISize is the size in bytes to be used for I-frames.
  * pname:framePSize is the size in bytes to be used for P-frames.
  * pname:frameBSize is the size in bytes to be used for B-frames.

include::{generated}/validity/structs/VkVideoEncodeH265FrameSizeEXT.adoc[]
--

